<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>Chat Bot</title>
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <body>
    <div class="chat">
      <h1>Chat Bot</h1>
      <div id="messages"></div>
      <form id="chat-form">
        <input id="msg" autocomplete="off" placeholder="Gõ tin nhắn..." />
        <button type="submit">Gửi</button>
      </form>
      <button id="logout">Đăng xuất</button>
    </div>

    <script src="/static/js/chat.js"></script>
    <script>
      const form = document.getElementById('chat-form');
      const messagesEl = document.getElementById('messages');
      const logoutBtn = document.getElementById('logout');

      function appendMessage(text, cls) {
        const d = document.createElement('div');
        d.className = 'message ' + cls;
        d.textContent = text;
        messagesEl.appendChild(d);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('msg');
        const text = input.value.trim();
        if (!text) return;
        appendMessage(text, 'user');
        input.value = '';
        appendMessage('...', 'bot');
        const res = await sendEcho(text);
        // remove the '...' placeholder
        const last = messagesEl.querySelectorAll('.message.bot');
        if (last.length) last[last.length - 1].textContent = res.reply || res.error || 'No reply';
      });

      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('access_token');
        window.location.href = '/login';
      });

      // ensure token exists, otherwise redirect to login
      (function ensureAuth() {
        const token = localStorage.getItem('access_token');
        if (!token) window.location.href = '/login';
      })();
    </script>
  </body>
</html>
